// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password          String
  name              String?
  profilePicture    String?  @map("profile_picture")
  catalogConnected  Boolean  @default(false) @map("catalog_connected")
  catalogId         String?  @map("catalog_id")
  createdAt         DateTime @default(now()) @map("created_at")

  products          Product[]
  generatedPosts    GeneratedPost[]

  @@map("users")
}

model Product {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  sku         String
  title       String
  description String
  price       Float
  imageUrl    String   @map("image_url")
  purchaseUrl String?  @map("purchase_url")
  catalogId   String?  @map("catalog_id")
  createdAt   DateTime @default(now()) @map("created_at")

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedPosts  GeneratedPost[]
  checkoutSessions CheckoutSession[]

  @@unique([userId, title], name: "userId_title")
  @@map("products")
}

model GeneratedPost {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  productId       String   @map("product_id")
  type            String
  content         String
  mediaUrl        String   @map("media_url")
  status          String   @default("draft")
  sharedToFacebook Boolean @default(false) @map("shared_to_facebook")
  sharedToInstagram Boolean @default(false) @map("shared_to_instagram")
  facebookPostId  String?  @map("facebook_post_id")
  instagramPostId String?  @map("instagram_post_id")
  createdAt       DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("generated_posts")
}

model CheckoutSession {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  checkoutUrl String   @map("checkout_url")
  status      String   @default("pending")
  createdAt   DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("checkout_sessions")
}

model Session {
  sid    String   @id
  sess   Json
  expire DateTime

  @@index([expire])
  @@map("session")
}

// UGC Creative Generation Session
model UgcSession {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  productId         String   @map("product_id")
  title             String?  @default("New Session")
  
  // Step 0: Demographics & Prompts
  targetDemographic Json?    @map("target_demographic")
  productPrompt     String?  @map("product_prompt")
  characterPrompt   String?  @map("character_prompt")
  scenes            Json?    // Array of scene prompts
  
  // Step 1: Character Generation
  generatedCharacters Json?  @map("generated_characters") // Array of character image URLs
  selectedCharacter   String? @map("selected_character")
  
  // Step 2: Character with Product
  generatedProductImages Json? @map("generated_product_images") // Array of image URLs
  selectedProductImage   String? @map("selected_product_image")
  
  // Step 3: Scene Editing
  editedScenes      Json?    @map("edited_scenes") // User-edited scenes array
  
  // Step 4: Video Generation
  videoUrl          String?  @map("video_url")
  videoProgress     Int      @default(0) @map("video_progress") // 0-100
  
  // Status tracking
  currentStep       Int      @default(0) @map("current_step")
  status            String   @default("draft") // draft, generating, completed, failed
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("ugc_sessions")
}

// LLM API Usage Tracking (for admin dashboard)
model LlmUsageRecord {
  id            String   @id @default(uuid())
  type          String   // 'text-to-text', 'text-to-image', 'text-to-video'
  model         String   // Model name used (e.g., 'gemini-2.0-flash')
  promptPreview String?  @map("prompt_preview") // First 100 chars of prompt
  success       Boolean  @default(true)
  durationMs    Int?     @map("duration_ms")
  errorMessage  String?  @map("error_message")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([type])
  @@index([createdAt])
  @@map("llm_usage_records")
}

// Scene Video Generation Jobs (async video generation tracking)
model SceneVideoJob {
  id            String   @id @default(uuid())
  sessionId     String   @map("session_id")
  sceneIndex    Int      @map("scene_index")
  status        String   @default("queued") // queued, generating, completed, failed
  progress      Int      @default(0)        // 0-100 percentage
  videoUrl      String?  @map("video_url")
  errorMessage  String?  @map("error_message")
  prompt        String?                     // The prompt used for generation
  imageUrl      String?  @map("image_url")  // The source image URL
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([sessionId, sceneIndex])
  @@index([sessionId])
  @@index([status])
  @@map("scene_video_jobs")
}
